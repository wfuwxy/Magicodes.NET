var magicodes=magicodes||{};magicodes.api={request:function(n,t){switch(n.toUpperCase()){case"GET":case"DELETE":this._sendRequest({url:t.url,type:n,data:t.data,func:t.func,error:t.error});break;case"POST":case"PUT":this._sendRequest({url:t.url,type:n,data:JSON.stringify(t.data),func:t.func,error:t.error});break;default:this._sendRequest({url:t.url,type:n,data:t.data,func:t.func,error:t.error})}},_sendRequest:function(n){$.ajax({url:n.url,type:n.type,data:n.data,cache:!1,accepts:"application/json",dataType:"json",contentType:"application/json; charset=utf-8",statusCode:{200:function(t){$.isFunction(n.func)&&n.func(t,200)},201:function(t){$.isFunction(n.func)&&n.func(t,201)},401:function(){window.location.href="/Login"},204:function(t){$.isFunction(n.func)&&n.func(t,204)},400:function(t){var i=$.parseJSON(t.responseText),r,u,f;if(!$.isFunction(n.error)||!n.error(i,400))if(i.error)r=i.error.innererror&&i.error.innererror.message?i.error.innererror.message:i.error.message,magicodes.messager.showErrorMessage("错误",r.replace(/\r\n/gi,"<br />"));else if(i.ModelState){r=i.Message;u="<br />";for(f in i.ModelState)u+=i.ModelState[f]+"<br />";magicodes.messager.showErrorMessage("错误",r.replace(/\r\n/gi,"<br />")+u)}},500:function(t){var i=$.parseJSON(t.responseText),r;$.isFunction(n.error)&&n.error(i,400)||(i.error?(r=i.error.innererror&&i.error.innererror.message?i.error.innererror.message:i.error.message,magicodes.messager.showErrorMessage("操作失败",r.replace(/\r\n/gi,"<br />"))):i.Message?(r=i.Message,magicodes.messager.showErrorMessage("操作失败",r.replace(/\r\n/gi,"<br />"))):i.message&&(r=i.message,magicodes.messager.showErrorMessage("操作失败",r.replace(/\r\n/gi,"<br />"))))}}}).fail(function(n){var t=$.parseJSON(n.responseText);console.error(t)})}};magicodes.odataGrid=function(n){var t={url:"",onloaded:function(){},bindElement:null,onViewModelCreated:null,keyName:"Id",keyType:"string",filterTemplate:null,$orderby:null,pageSize:10,onBound:null,onBinding:null},that;return this.options=$.extend(t,n),that=this,this.ViewModel=function(){var self=this,n;this.gridViewModel={pages:ko.observable([]),dataRows:ko.observableArray([]),pageSize:ko.observable(typeof that.options.pageSize=="undefined"?10:that.options.pageSize),totalCount:ko.observable(0),currentPageIndex:ko.observable(1),pageOptions:ko.observableArray([10,25,50,100])};this.$filter=null;this.$orderby=null;this.$select=null;this.loading=ko.observable(!1);this.formData=ko.observable(null);this.firstLoad=!0;n=that.options.bindElement||document.body;self.loading.subscribe(function(n){n});this.addItem=function(n){this.items.push(n)};this.nextPage=function(){this.gridViewModel.currentPageIndex()<this.getTotalPages()&&this.gridViewModel.currentPageIndex(this.gridViewModel.currentPageIndex()+1)};this.previousPage=function(){this.gridViewModel.currentPageIndex()>1&&this.gridViewModel.currentPageIndex(this.gridViewModel.currentPageIndex()-1)};this.getTotalPages=function(){var n=this.gridViewModel.totalCount()/this.gridViewModel.pageSize();return Math.floor(n)+(n>Math.floor(n)?1:0)};this.getPagesArr=function(){var i=this.getTotalPages(),u=i>10?10:i,n=this.gridViewModel.currentPageIndex(),t=1,r=u;return n>5&&(i-n>5?(t=n-4,r=n+5):(t=n-9,r=i)),t<1&&(t=1),ko.utils.range(t,r)};this.filter=function(){if(that.options.filterTemplate!=null&&typeof that.options.filterTemplate!="undefined"&&that.options.filterTemplate.length>0){var n=that.options.filterTemplate,t=n.replace(/\{[^\}]+\}/ig,function(n){var t=$(n.substr(1,n.length-2));return"'"+(t.length>0?t.val():"")+"'"});this.$filter=t}};this.search=function(){self.filter();self.loadData()};self.gridViewModel.totalCount.subscribe(function(){});self.gridViewModel.currentPageIndex.subscribe(function(){self.loadData()});self.gridViewModel.pageSize.subscribe(function(){var n=self.getTotalPages();self.gridViewModel.pages(self.getPagesArr());self.gridViewModel.currentPageIndex()>n&&self.gridViewModel.currentPageIndex(1);self.loadData()});this.loadData=function(){self.filter();var n={$count:!0,$top:this.gridViewModel.pageSize(),$skip:(this.gridViewModel.currentPageIndex()-1)*this.gridViewModel.pageSize()};self.$filter!=null&&(n.$filter=self.$filter);self.$orderby!=null&&(n.$orderby=self.$orderby);self.loading(!0);magicodes.api.request("GET",{url:that.options.url,data:n,func:function(n){$.each(n.value,function(n,t){t._selected=ko.observable(!1)});self.gridViewModel.dataRows(n.value);self.gridViewModel.totalCount(n["@odata.count"]);self.gridViewModel.pages(self.getPagesArr());self.loading(!1)}})};this.init=function(){that.options.$orderby&&(self.$orderby=that.options.$orderby);that.options.$select&&(self.$select=that.options.$select);this.loadData()};this.isAllSelected=ko.computed({read:function(){var n=ko.utils.arrayFirst(self.gridViewModel.dataRows(),function(n){return!n._selected()});return n==null},write:function(n){ko.utils.arrayForEach(self.gridViewModel.dataRows(),function(t){t._selected(n)})}});this.removeSelectedRows=function(){var n=self.getSelectedRows(),ids;if(n.length==0){magicodes.messager.showWarnMessage("警告","请先选择需要删除的项！");return}ids="";$.each(n,function(){ids+=eval("v."+that.options.keyName)+"-"});ids=ids.substr(0,ids.length-1);(new magicodes.dialog).bootbox.confirm({message:"确定要删除所选项么？",func:function(){var count=n.length;$.each(n,function(){var url=self.getGetUrl(eval("v."+that.options.keyName));window.magicodes.api.request("DELETE",{url:url,data:{},func:function(){count--;count==0&&(self.gridViewModel.currentPageIndex(1),self.loadData(),magicodes.messager.showInfoMessage("温馨提示","操作成功！"))}})})}})};this.getSelectedRows=function(){return $.grep(self.gridViewModel.dataRows(),function(n){return n._selected()})};this.getQuotes=function(){return that.options.keyType=="string"?"'":""};this.getGetUrl=function(n){return that.options.url+"("+self.getQuotes()+n+self.getQuotes()+")"};this.loadData()},this.bindingModel=function(){var n=new that.ViewModel;return that.options.onBinding&&that.options.onBinding(n),that.options.bindElement==null?ko.applyBindings(n):ko.applyBindings(n,that.options.bindElement),that.options.onBound&&that.options.onBound(n),n},this.bindingModel()};
//# sourceMappingURL=odataGrid.min.js.map
